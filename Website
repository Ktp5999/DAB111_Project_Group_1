# Importing the libraries 
import sqlite3
import pandas as pd
import csv
from flask import Flask, render_template_string, render_template
from werkzeug.serving import run_simple

# Importing the dataset (Netflix)
df = pd.read_csv("C:/Users/Lenovo/OneDrive - St. Clair College/SEM_1/DAB 111 Pyhton Programming/netflix1.csv")
df.head(10)

# Craeting a database
con = sqlite3.connect('Netflix.db')
cursor = con.cursor()

# Creating a table (movies)
create_table = """CREATE TABLE IF NOT EXISTS movies(
                        show_id VARCHAR(50) PRIMARY KEY,
                        type VARCHAR(20),
                        title VARCHAR(255),
                        director VARCHAR(255),
                        country VARCHAR(100),
                        date_added DATE,
                        release_year INT,
                        rating VARCHAR(10),
                        duration VARCHAR(20),
                        listed_in VARCHAR(255)
                        )"""
cursor.execute(create_table)
df.to_sql('movies', con, if_exists='replace', index=False)

con.commit()
con.close()

# Creating the home page
@app.route('/')
def home():
    return render_template_string('''
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>DAB111 Project Group 1</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <style>
            body {
                background-color: #f8f9fa;
            }
            .container {
                margin-top: 20px;
            }
            header {
                background-color: #343a40;
                color: white;
                padding: 10px 0;
                text-align: center;
                margin-bottom: 20px;
            }
            nav a {
                color: white;
                margin: 0 10px;
                padding: 10px 20px;
                border-radius: 5px;
                background-color: #007bff;
                transition: background-color 0.3s, transform 0.3s;
            }
            nav a:hover {
                background-color: #0056b3;
                transform: scale(1.1);
            }
            .highlight {
                color: #dc3545;
            }
        </style>
    </head>
    <body>
        <header>
            <h1>DAB111 Project Group 1</h1>
            <nav class="nav justify-content-center">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link" href="/about">About</a>
                <a class="nav-link" href="/data">Data</a>
            </nav>
        </header>
        <div class="container">
            <h2>Project Overview</h2>
            <p>Netflix is a popular streaming service that offers a vast catalog of movies, TV shows, and original contents. This dataset is a cleaned version of the original version which can be found here. The data consist of contents added to Netflix from 2008 to 2021. The oldest content is as old as 1925 and the newest as 2021.</p>
            <p>My name is Mr. Krunal and welcome to my page.</p>
        </div>
    </body>
    </html>
    ''')

@app.route('/about')
def about():
    return render_template_string('''
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>About Us - DAB111 Project Group 1</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <style>
            body {
                background-color: #f8f9fa;
            }
            .container {
                margin-top: 20px;
            }
            header {
                background-color: #343a40;
                color: white;
                padding: 10px 0;
                text-align: center;
                margin-bottom: 20px;
            }
            nav a {
                color: white;
                margin: 0 10px;
                padding: 10px 20px;
                border-radius: 5px;
                background-color: #007bff;
                transition: background-color 0.3s, transform 0.3s;
            }
            nav a:hover {
                background-color: #0056b3;
                transform: scale(1.1);
            }
        </style>
    </head>
    <body>
        <header>
            <h1>About Us - DAB111 Project Group 1</h1>
            <nav class="nav justify-content-center">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link" href="/about">About</a>
                <a class="nav-link" href="/data">Data</a>
            </nav>
        </header>
        <div class="container">
            <h2>About Us</h2>
            <p>We are Group 1 of the DAB111 project, focused on using data to solve real-world problems.</p>
        </div>
    </body>
    </html>
    ''')


# Dataset and Operating the new query 
@app.route('/data')
def data():
    # Connect to SQLite database and fetch data
    con = sqlite3.connect('Netflix.db')
    c = con.cursor()
    
    # Fetch the first 10 rows
    c.execute('SELECT * FROM movies LIMIT 10')
    data = c.fetchall()
    
    # Fetch the first 5 rows for the second table
    d = con.cursor()
    d.execute('SELECT * FROM movies LIMIT 5')
    data_movies = d.fetchall()
    
    # Convert the fetched data to a DataFrame for further operations
    df = pd.DataFrame(data, columns=['show_id', 'type', 'title', 'director', 'country', 'date_added', 'release_year', 'rating', 'duration', 'listed_in'])

    # Perform some basic operations
    movie_count = len(df)
    avg_release_year = df['release_year'].mean()
    rating_counts = df['rating'].value_counts().to_dict()
    
    # Generate HTML for the full data table
    data_html = df.to_html(classes='table table-striped', index=False)

    # Convert fetched data for the additional table
    df_movies = pd.DataFrame(data_movies, columns=['show_id', 'type', 'title', 'director', 'country', 'date_added', 'release_year', 'rating', 'duration', 'listed_in'])
    data_movies_html = df_movies.to_html(classes='table table-bordered', index=False)
    
    con.close()

    return render_template_string('''
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Data - DAB111 Project Group 1</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <style>
            body {
                background-color: #f8f9fa;
            }
            header {
                background-color: #343a40;
                color: white;
                padding: 10px 0;
                text-align: center;
                margin-bottom: 20px;
            }
            nav a {
                color: white;
                margin: 0 10px;
                padding: 10px 20px;
                border-radius: 5px;
                background-color: #007bff;
                transition: background-color 0.3s, transform 0.3s;
            }
            nav a:hover {
                background-color: #0056b3;
                transform: scale(1.1);
            }
        </style>
    </head>
    <body>
        <header>
            <h1>Data - DAB111 Project Group 1</h1>
            <nav class="nav justify-content-center">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link" href="/about">About</a>
                <a class="nav-link" href="/data">Data</a>
            </nav>
        </header>
        <div class="container">
            <h2>Full Data Sample</h2>
            {{ data|safe }}
            <h3>First 5 Records from the Database</h3>
            {{ data_movies|safe }}
            
            <h3>Operations Summary</h3>
            <p><strong>Total Movie Count:</strong> {{ movie_count }}</p>
            <p><strong>Average Release Year:</strong> {{ avg_release_year | round(0) }}</p>
            <p><strong>Rating Counts:</strong></p>
            <ul>
                {% for rating, count in rating_counts.items() %}
                <li>{{ rating }}: {{ count }}</li>
                {% endfor %}
            </ul>
        </div>
    </body>
    </html>
    ''', data=data_html, data_movies=data_movies_html, movie_count=movie_count, avg_release_year=avg_release_year, rating_counts=rating_counts)

run_simple('localhost',9000,app,use_reloader=False, use_debugger=False)
